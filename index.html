<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmhouse Bogor - Official Sync</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #27ae60; --bg: #f8f9fa; --card: #ffffff; --text: #333; --border: #ddd; --zebra: #f2f2f2; }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --zebra: #252525; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 20px; background: var(--bg); color: var(--text); transition: 0.3s; }
        .container { max-width: 1600px; margin: auto; }
        
        .header-app { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .sync-info { font-size: 0.85em; margin-top: 5px; color: white; background: #2c3e50; padding: 5px 12px; border-radius: 20px; display: inline-block; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; font-weight: bold; }
        
        .input-section { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; border-top: 6px solid var(--primary); }
        .filter-container { background: var(--card); padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; border-bottom: 1px solid var(--border); }
        .input-group label { font-size: 0.7em; font-weight: bold; margin-bottom: 5px; color: var(--primary); text-transform: uppercase; display: block; }
        
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: transparent; color: var(--text); outline: none; width: 100%; box-sizing: border-box; }
        body.dark-mode select option { background: #1e1e1e; color: #e0e0e0; }
        
        .table-container { overflow-x: auto; background: var(--card); border-radius: 0 0 12px 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 1300px; font-size: 0.85em; }
        th, td { border: 1px solid var(--border); padding: 8px 5px; text-align: center; }
        th { background: #f2f2f2; color: #333; font-weight: bold; font-size: 0.7em; text-transform: uppercase; }
        tbody tr:nth-child(even) { background-color: var(--zebra); }
        
        .td-edit input, .td-edit select { border: none; background: transparent; text-align: center; color: inherit; font-size: 1.05em; }
        .td-edit input:focus, .td-edit select:focus { background: #ffffff !important; color: #000000 !important; outline: 2px solid var(--primary); border-radius: 4px; }

        .bg-earning { background: #27ae60 !important; color: white !important; }
        .txt-transfer { color: #e67e22 !important; font-weight: 900; } 
        .txt-tomy { color: #3498db !important; font-weight: 900; }     
        .txt-kasbon { color: #e74c3c !important; font-weight: 900; }
        .row-pinjam { color: #ff4d4d !important; font-weight: bold; }
        .row-bayar { color: #2ecc71 !important; font-weight: bold; }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .dot-red { background-color: #e74c3c; box-shadow: 0 0 5px #e74c3c; }

        .vcard-scroll { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 12px; }
        .vcard-user { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 12px; border-radius: 12px; min-width: 160px; border-left: 5px solid #e74c3c; flex-shrink: 0; }
        .vcard-user .amt { color: #ffff00; font-weight: 800; font-size: 1.1em; }

        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .modal-content { background: var(--card); margin: 1% auto; padding: 25px; border-radius: 15px; width: 95%; max-width: 1500px; color: var(--text); max-height: 96vh; overflow-y: auto; }
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; z-index:9999; }
        button { cursor: pointer; border-radius: 8px; font-weight: bold; border: none; padding: 10px 15px; }
    </style>
</head>
<body class="dark-mode">

<div id="loginOverlay">
    <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px;">
        <h2 style="color:#333; margin:0 0 20px 0;">üîê FARMHOUSE LOGIN</h2>
        <input type="password" id="pinInput" style="text-align:center; font-size:2em; border: 2px solid #ddd;">
        <button style="background:#27ae60; color:white; width:100%; padding:15px; margin-top:20px" onclick="checkPin()">MASUK</button>
    </div>
</div>

<div class="container">
    <div class="header-app">
        <div>
            <h2 style="margin:0; color:var(--primary)">Farmhouse Bogor Official</h2>
            <div id="syncStatus" class="sync-info">üìç Menghubungkan...</div>
        </div>
        <div style="display:flex; gap:10px">
            <button style="background:#e74c3c; color:white" onclick="bukaKasbonPrompt()">üí∞ Kasbon</button>
            <button style="background:#9b59b6; color:white" onclick="openAccountWithPassword()">üîë Akun Game</button>
            <button style="background:#2c3e50; color:white" onclick="toggleDarkMode()">üåô Mode</button>
            <button style="background:#3498db; color:white" onclick="exportData()">üíæ Backup</button>
            <button style="background:#f39c12; color:white" onclick="document.getElementById('fileRestore').click()">üìÇ Restore</button>
            <input type="file" id="fileRestore" style="display:none" onchange="importData(this)" accept=".json">
            <button style="background:#7f8c8d; color:white" onclick="logout()">üîí Keluar</button>
        </div>
    </div>

    <div id="summaryStats" class="stats-grid"></div>

    <div class="input-section">
        <div class="input-group" style="grid-column: span 2;">
            <label>NAMA PEKERJA</label>
            <div style="display: flex; gap: 5px;">
                <select id="namaOrang"></select>
                <button onclick="tambahPekerja()" style="background:#3498db; color:white;">+</button>
                <button onclick="hapusPekerja()" style="background:#e74c3c; color:white;">‚úï</button>
            </div>
        </div>
        <div class="input-group"><label>TANGGAL</label><input type="date" id="tgl"></div>
        <div class="input-group"><label>CEGEL (Raw)</label><input type="text" id="cegel" onkeyup="formatInputNoRp(this)"></div>
        <div class="input-group"><label>RATE</label><input type="text" id="rate" onkeyup="formatInput(this)"></div>
        <div class="input-group"><label>GUARD</label><input type="text" id="guardian" onkeyup="formatInput(this)"></div>
        <div class="input-group"><label>MAKAN</label><input type="text" id="makan" value="Rp 10.000" onkeyup="formatInput(this)"></div>
        <div class="input-group"><label>KASBON (Bayar)</label><input type="text" id="kasbon" onkeyup="formatInput(this)"></div>
        <button style="background:#27ae60; color:white;" onclick="simpanData()">SIMPAN</button>
    </div>

    <div class="filter-container">
        <div class="filter-group"><label>CARI NAMA</label><input type="text" id="filterName" placeholder="Ketik nama..." onkeyup="muatSemua()"></div>
        <div class="filter-group"><label>DARI TANGGAL</label><input type="date" id="filterStart" onchange="muatSemua()"></div>
        <div class="filter-group"><label>SAMPAI TANGGAL</label><input type="date" id="filterEnd" onchange="muatSemua()"></div>
        <button style="background:#7f8c8d; color:white; margin-left:auto" onclick="resetFilter()">RESET</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="2" style="width:130px">NAMA</th><th rowspan="2" style="width:110px">TANGGAL</th><th colspan="4" class="bg-earning">PERFORMA</th><th colspan="2" class="bg-header-dark">BAGI HASIL</th><th rowspan="2" style="background:#ffff00; color:#000; width:110px">GUARD</th><th rowspan="2" style="width:110px">MAKAN</th><th rowspan="2" style="background:#ff0000; color:#fff; width:110px">KASBON</th><th rowspan="2" style="width:50px">X</th>
                </tr>
                <tr>
                    <th class="bg-earning">CEGEL</th><th class="bg-earning">M</th><th class="bg-earning">RATE</th><th class="bg-earning">TOTAL</th><th style="background:#d35400; color:white">TRANSFER</th><th style="background:#2980b9; color:white">TOMY</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="modalKasbon" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:#e74c3c; margin:0;">üí∞ KASBON & OPERASIONAL</h2>
            <button onclick="document.getElementById('modalKasbon').style.display='none'" style="background:#333; color:white;">‚úï</button>
        </div>
        <div class="vcard-container">
            <div style="font-size:0.7em; font-weight:bold; color:#95a5a6; margin-bottom:5px">SALDO OPERASIONAL</div>
            <div id="vcardOps" class="vcard-scroll"></div>
            <div style="font-size:0.7em; font-weight:bold; color:#95a5a6; margin:10px 0 5px 0">SALDO PRIBADI</div>
            <div id="vcardPribadi" class="vcard-scroll"></div>
        </div>
        <div class="input-section" style="border-top: 6px solid #e74c3c;">
            <div class="input-group"><label>TANGGAL</label><input type="date" id="k_tgl"></div>
            <div class="input-group"><label>NAMA</label><select id="k_nama"></select></div>
            <div class="input-group"><label>KAT</label><div style="display:flex; gap:3px;"><select id="k_kat" style="flex:1"></select><button onclick="tambahKategori()" style="background:#3498db; color:white;">+</button><button onclick="hapusKategori()" style="background:#e74c3c; color:white;">‚úï</button></div></div>
            <div class="input-group"><label>JENIS</label><select id="k_jenis"><option value="PINJAM">PINJAM</option><option value="BAYAR">BAYAR</option></select></div>
            <div class="input-group"><label>JUMLAH</label><input type="text" id="k_jumlah" onkeyup="formatInput(this)"></div>
            <div class="input-group" style="grid-column: span 2;"><label>KET</label><input type="text" id="k_ket"></div>
            <button style="background:#e74c3c; color:white;" onclick="simpanKasbonManual()">SIMPAN</button>
        </div>
        <div class="table-container" style="max-height: 40vh;">
            <table><thead><tr style="background:#2c3e50; color:#fff"><th>TGL</th><th>NAMA</th><th>KAT</th><th>JENIS</th><th>JUMLAH</th><th>KET</th><th>X</th></tr></thead><tbody id="kasbonTableBody"></tbody></table>
        </div>
    </div>
</div>

<div id="accountModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0; color:#9b59b6">üîë Akun Game Sync</h2>
            <div><button onclick="tambahAkunBaru()" style="background:#3498db; color:white;">+ CHAR</button><button onclick="document.getElementById('accountModal').style.display='none'" style="background:#e74c3c; color:white; margin-left:10px;">‚úï</button></div>
        </div>
        <div class="table-container"><table><thead><tr><th>STATUS</th><th>CHAR</th><th>USER ID</th><th>PASS</th><th>PEKERJA</th><th>X</th></tr></thead><tbody id="accountTableBody"></tbody></table></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBphHlavM7eC56wLJ1CUcSi4-yc5YwLcl0",
        authDomain: "farmhouse-dd33a.firebaseapp.com",
        databaseURL: "https://farmhouse-dd33a-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "farmhouse-dd33a",
        storageBucket: "farmhouse-dd33a.firebasestorage.app",
        messagingSenderId: "527376522624",
        appId: "1:527376522624:web:465177a2721c104551f565"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let localDB = {};

    db.ref('/').on('value', snap => {
        localDB = snap.val() || {};
        updateSelects(); 
        muatSemua();     
        if(document.getElementById('accountModal').style.display === 'block') muatDataAkun();
    });

    function updateSelects() {
        const pks = localDB.daftarPekerja ? Object.values(localDB.daftarPekerja).sort() : [];
        const kats = localDB.daftarKategori ? Object.values(localDB.daftarKategori).sort() : [];
        ['namaOrang', 'k_nama'].forEach(id => {
            const el = document.getElementById(id); if(!el) return;
            const cur = el.value; el.innerHTML = '<option value="">-- Pilih --</option>';
            pks.forEach(p => el.innerHTML += `<option value="${p}">${p}</option>`);
            el.value = cur;
        });
        const ekat = document.getElementById('k_kat'); if(ekat) {
            const cur = ekat.value; ekat.innerHTML = '<option value="">-- Pilih --</option>';
            kats.forEach(k => ekat.innerHTML += `<option value="${k}">${k}</option>`);
            ekat.value = cur;
        }
    }

    function muatSemua() {
        const fS = document.getElementById('filterStart').value, fE = document.getElementById('filterEnd').value, fN = document.getElementById('filterName').value.toLowerCase();
        const body = document.getElementById('tableBody'); body.innerHTML = '';
        const kBody = document.getElementById('kasbonTableBody'); kBody.innerHTML = '';
        const vOps = document.getElementById('vcardOps'); vOps.innerHTML = '';
        const vPri = document.getElementById('vcardPribadi'); vPri.innerHTML = '';
        let tkot = 0, ttra = 0, tkasE = 0, tkasO = 0, count = 0;
        const pks = localDB.daftarPekerja ? Object.values(localDB.daftarPekerja).sort() : [];
        const kats = localDB.daftarKategori ? Object.values(localDB.daftarKategori).sort() : [];
        const dEarn = localDB.earningData || {};
        Object.keys(dEarn).sort((a,b) => new Date(dEarn[b].tgl) - new Date(dEarn[a].tgl)).forEach(k => {
            const i = dEarn[k];
            if((fS && i.tgl < fS) || (fE && i.tgl > fE) || (fN && !i.namaOrang.toLowerCase().includes(fN))) return;
            count++;
            let kot = ((i.cegel||0)/1000000) * (i.rate||0);
            let hTra = (((kot - (i.guardian||0)) / 2) + (i.makan || 0)) - (i.kasbon || 0);
            let hTom = ((kot - (i.guardian||0)) / 2) - (i.makan || 0);
            tkot += kot; ttra += hTra; tkasE += (i.kasbon || 0);
            body.innerHTML += `<tr>
                <td class="td-edit"><select onchange="upEarn('${k}','namaOrang',this.value)">${pks.map(p=>`<option value="${p}" ${p===i.namaOrang?'selected':''}>${p}</option>`).join('')}</select></td>
                <td class="td-edit"><input type="date" value="${i.tgl}" onchange="upEarn('${k}','tgl',this.value)"></td>
                <td class="td-edit"><input type="text" value="${(i.cegel||0).toLocaleString('id-ID')}" onchange="upEarnNum('${k}','cegel',this.value)"></td>
                <td>${((i.cegel||0)/1000000).toFixed(1)}M</td>
                <td class="td-edit"><input type="text" value="${fmtRp(i.rate||0)}" onchange="upEarnNum('${k}','rate',this.value)" onkeyup="formatInput(this)"></td>
                <td>${fmtRp(kot)}</td><td class="txt-transfer">${fmtRp(hTra)}</td><td class="txt-tomy">${fmtRp(hTom)}</td>
                <td class="td-edit"><input type="text" value="${fmtRp(i.guardian||0)}" onchange="upEarnNum('${k}','guardian',this.value)" onkeyup="formatInput(this)"></td>
                <td class="td-edit"><input type="text" value="${fmtRp(i.makan||0)}" onchange="upEarnNum('${k}','makan',this.value)" onkeyup="formatInput(this)"></td>
                <td class="td-edit txt-kasbon"><input type="text" value="${fmtRp(i.kasbon||0)}" onchange="upEarnNum('${k}','kasbon',this.value)" onkeyup="formatInput(this)"></td>
                <td><button onclick="hapusEarning('${k}','${i.syncID||''}')">‚úï</button></td>
            </tr>`;
        });
        const dKas = localDB.dbKasbon || {};
        let rOps = {}, rPri = {};
        Object.keys(dKas).reverse().forEach(k => {
            const i = dKas[k];
            const isOps = (i.kategori || '').toLowerCase().includes('operasional');
            const targetRek = isOps ? rOps : rPri;
            if(!targetRek[i.nama]) targetRek[i.nama] = {p:0, b:0};
            if(i.jenis === 'PINJAM') { targetRek[i.nama].p += (i.jumlah||0); if(isOps) tkasO += i.jumlah; } else targetRek[i.nama].b += (i.jumlah||0);
            kBody.innerHTML += `<tr class="${i.jenis === 'PINJAM' ? 'row-pinjam' : 'row-bayar'}">
                <td class="td-edit"><input type="date" value="${i.tgl}" onchange="upKas('${k}','tgl',this.value)"></td>
                <td class="td-edit"><select onchange="upKas('${k}','nama',this.value)">${pks.map(p=>`<option value="${p}" ${p===i.nama?'selected':''}>${p}</option>`).join('')}</select></td>
                <td class="td-edit"><select onchange="upKas('${k}','kategori',this.value)">${kats.map(c=>`<option value="${c}" ${c===i.kategori?'selected':''}>${c}</option>`).join('')}</select></td>
                <td class="td-edit"><select onchange="upKas('${k}','jenis',this.value)"><option value="PINJAM" ${i.jenis==='PINJAM'?'selected':''}>PINJAM</option><option value="BAYAR" ${i.jenis==='BAYAR'?'selected':''}>BAYAR</option></select></td>
                <td class="td-edit"><input type="text" value="${fmtRp(i.jumlah||0)}" onchange="upKasNum('${k}','jumlah',this.value)" onkeyup="formatInput(this)"></td>
                <td class="td-edit"><input type="text" value="${i.ket||''}" onchange="upKas('${k}','ket',this.value)"></td>
                <td><button onclick="hapus('dbKasbon/${k}')">‚úï</button></td>
            </tr>`;
        });
        const renderV = (rek, target) => Object.keys(rek).sort().forEach(nm => { const sisa = rek[nm].p - rek[nm].b; if(sisa !== 0) target.innerHTML += `<div class="vcard-user"><b>üë§ ${nm}</b><br><span class="amt">${fmtRp(sisa)}</span></div>`; });
        renderV(rOps, vOps); renderV(rPri, vPri);
        document.getElementById('syncStatus').innerText = `üìç Terhubung (${count} Data)`;
        document.getElementById('summaryStats').innerHTML = `<div class="stat-card" style="background:#27ae60"><div>KOTOR</div><div style="font-size:1.4em">${fmtRp(tkot)}</div></div><div class="stat-card" style="background:#e67e22"><div>TRANSFER</div><div style="font-size:1.4em">${fmtRp(ttra)}</div></div><div class="stat-card" style="background:#c0392b"><div>BON EARN</div><div style="font-size:1.4em">${fmtRp(tkasE)}</div></div><div class="stat-card" style="background:#2c3e50"><div>BON OPS</div><div style="font-size:1.4em">${fmtRp(tkasO)}</div></div>`;
    }

    function muatDataAkun() {
        const tbody = document.getElementById('accountTableBody'); tbody.innerHTML = '';
        const akun = localDB.dataAkun || {};
        const pks = localDB.daftarPekerja ? Object.values(localDB.daftarPekerja).sort() : [];
        Object.keys(akun).forEach(k => {
            const d = akun[k], isUsed = (d.pekerja && d.pekerja !== "");
            tbody.innerHTML += `<tr>
                <td><span class="status-dot ${isUsed?'dot-green':'dot-red'}"></span> ${isUsed?'Terpakai':'Tersedia'}</td>
                <td class="td-edit"><input type="text" value="${d.char||''}" onchange="db.ref('dataAkun/${k}/char').set(this.value)"></td>
                <td class="td-edit"><input type="text" value="${d.user||''}" onchange="db.ref('dataAkun/${k}/user').set(this.value)"></td>
                <td class="td-edit"><input type="text" value="${d.pass||''}" onchange="db.ref('dataAkun/${k}/pass').set(this.value)"></td>
                <td class="td-edit"><select onchange="db.ref('dataAkun/${k}/pekerja').set(this.value)"><option value="">-- Kosong --</option>${pks.map(p=>`<option value="${p}" ${p===d.pekerja?'selected':''}>${p}</option>`).join('')}</select></td>
                <td><button onclick="hapus('dataAkun/${k}')">‚úï</button></td>
            </tr>`;
        });
    }

    function hapusPekerja() {
        const sel = document.getElementById('namaOrang').value;
        if(!sel) return alert("Pilih nama dulu!");
        if(confirm("Hapus " + sel + " dari daftar?")) {
            const list = localDB.daftarPekerja || {};
            const key = Object.keys(list).find(k => list[k] === sel);
            if(key) db.ref('daftarPekerja/' + key).remove();
        }
    }
    function hapusKategori() {
        const sel = document.getElementById('k_kat').value;
        if(!sel) return alert("Pilih kategori!");
        if(confirm("Hapus " + sel + "?")) {
            const list = localDB.daftarKategori || {};
            const key = Object.keys(list).find(k => list[k] === sel);
            if(key) db.ref('daftarKategori/' + key).remove();
        }
    }

    function simpanData() {
        const n = document.getElementById('namaOrang').value, t = document.getElementById('tgl').value, kVal = parseRaw(document.getElementById('kasbon').value);
        if(!n) return alert("Pilih Nama!");
        const sID = 'SYNC_' + Date.now();
        db.ref('earningData').push({ namaOrang: n, tgl: t, cegel: parseRaw(document.getElementById('cegel').value), rate: parseRaw(document.getElementById('rate').value), guardian: parseRaw(document.getElementById('guardian').value), makan: parseRaw(document.getElementById('makan').value), kasbon: kVal, syncID: sID });
        if(kVal > 0) {
            const katOps = (localDB.daftarKategori ? Object.values(localDB.daftarKategori) : []).find(k => k.toUpperCase().includes("OPERASIONAL")) || "OPERASIONAL";
            db.ref('dbKasbon').push({ tgl: t, nama: n, kategori: katOps, jenis: "BAYAR", jumlah: kVal, ket: "POTONG GAJI", syncID: sID });
        }
        ["cegel","rate","guardian","kasbon"].forEach(id => document.getElementById(id).value = '');
    }

    function hapusEarning(eKey, sID) {
        if(!confirm("Hapus?")) return;
        db.ref('earningData/' + eKey).remove();
        if(sID) { const dK = localDB.dbKasbon || {}; Object.keys(dK).forEach(k => { if(dK[k].syncID === sID) db.ref('dbKasbon/' + k).remove(); }); }
    }

    function fmtRp(v) { return 'Rp ' + Math.round(v).toLocaleString('id-ID'); }
    function parseRaw(s) { return parseFloat(s.toString().replace(/Rp/g, '').replace(/\./g, '').replace(/\s/g, '').replace(',', '.')) || 0; }
    function formatInput(obj) { let v = obj.value.replace(/[^0-9]/g, ''); obj.value = v ? 'Rp ' + parseInt(v).toLocaleString('id-ID') : ''; }
    function formatInputNoRp(obj) { let v = obj.value.replace(/[^0-9]/g, ''); obj.value = v ? parseInt(v).toLocaleString('id-ID') : ''; }
    function checkPin() { if(document.getElementById('pinInput').value === "1234") { localStorage.setItem("isLoggedIn", "true"); document.getElementById('loginOverlay').style.display = 'none'; } }
    function logout() { localStorage.removeItem("isLoggedIn"); location.reload(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function bukaKasbonPrompt() { if(prompt("Pass Kasbon:") === "tomy1234") document.getElementById('modalKasbon').style.display='block'; }
    function openAccountWithPassword() { if(prompt("Pass Akun:") === "54321") { document.getElementById('accountModal').style.display='block'; muatDataAkun(); } }
    function upEarn(id, f, v) { db.ref('earningData/' + id).update({ [f]: v }); }
    function upEarnNum(id, f, v) { db.ref('earningData/' + id).update({ [f]: parseRaw(v) }); }
    function upKas(id, f, v) { db.ref('dbKasbon/' + id).update({ [f]: v }); }
    function upKasNum(id, f, v) { db.ref('dbKasbon/' + id).update({ [f]: parseRaw(v) }); }
    function hapus(p) { if(confirm("Hapus?")) db.ref(p).remove(); }
    function tambahPekerja() { const n = prompt("Nama:"); if(n) db.ref('daftarPekerja').push(n); }
    function tambahKategori() { const k = prompt("Kategori:"); if(k) db.ref('daftarKategori').push(k); }
    function tambahAkunBaru() { const c = prompt("Char:"); if(c) db.ref('dataAkun').push({ char: c, user: '', pass: '', pekerja: '' }); }
    function simpanKasbonManual() {
        const n = document.getElementById('k_nama').value; if(!n) return alert("Pilih Nama!");
        db.ref('dbKasbon').push({ tgl: document.getElementById('k_tgl').value, nama: n, kategori: document.getElementById('k_kat').value, jenis: document.getElementById('k_jenis').value, jumlah: parseRaw(document.getElementById('k_jumlah').value), ket: document.getElementById('k_ket').value });
        document.getElementById('k_jumlah').value = ''; document.getElementById('k_ket').value = '';
    }
    function resetFilter() { document.getElementById('filterStart').value=''; document.getElementById('filterEnd').value=''; document.getElementById('filterName').value=''; muatSemua(); }
    
    // FUNGSI BACKUP & RESTORE
    function exportData() { db.ref('/').once('value').then(snap => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(snap.val(),null,2)],{type:'application/json'})); a.download='Backup_Farmhouse.json'; a.click(); }); }
    function importData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(confirm("‚ö†Ô∏è Timpa semua data cloud dengan file backup ini?")) {
                    db.ref('/').set(data).then(() => alert("‚úÖ Restore Berhasil!"));
                }
            } catch(err) { alert("‚ùå File tidak valid!"); }
        };
        reader.readAsText(file);
    }

    window.onload = () => {
        if(localStorage.getItem("isLoggedIn") === "true") document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('tgl').value = new Date().toISOString().split('T')[0];
        document.getElementById('k_tgl').value = new Date().toISOString().split('T')[0];
    };
</script>
</body>
</html>
